pr: [master]

trigger: [master]

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: fluent-secrets

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '10.x'
    displayName: 'Install Node.js'

  - script: |
      yarn
    displayName: Install dependencies

  - script: |
      yarn lint
    displayName: Lint

  - script: |
      yarn prettier
    displayName: Prettier

  - script: |
      yarn test --maxWorkers=2
    displayName: Unit tests

  - script: |
      bash <(curl -s https://codecov.io/bash)
    displayName: Report coverage

  - script: |
      yarn test:e2e
    displayName: E2E tests

  - script: |
      yarn test:projects
    displayName: Project tests

  - script: |
      if [ $BUILD_SOURCEBRANCHNAME == 'master' ]; then
        yarn stats:build
      else
        echo 'skip bundle statistics collection'
      fi
    displayName: Bundle statistics (master only)

  - script: |
      if [ $BUILD_SOURCEBRANCHNAME == 'master' ]; then yarn perf; fi
    displayName: Performance tests (master only)

  - script: |
      if [ $BUILD_SOURCEBRANCHNAME == 'master' ] && [ -n "${STATS_URI}" ]; then
        yarn stats:save --tag=`git tag --points-at HEAD`
      else
        echo 'skip saving statistics'
      fi
    displayName: Save statistics to DB (master only)

  - script: |
      if [ $BUILD_REASON == "PullRequest" ] && [ ! -z $DANGER_GITHUB_API_TOKEN ]; then
        echo "Running Danger JS"
        yarn danger ci
      elif [ $BUILD_REASON != "PullRequest" ]; then
        echo "Skipping Danger JS because BUILD_REASON ${BUILD_REASON} != PullRequest"
      else
        echo "Skipping Danger JS because API token wasn't found"
      fi
    displayName: Danger JS
